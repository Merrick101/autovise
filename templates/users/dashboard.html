{% extends "base.html" %}
{% load static %}

{% block title %}Your Dashboard | Autovise{% endblock %}

{% block content %}
<section class="container py-5">
  <h2 class="mb-4">Welcome, {{ user.first_name|default:user.username }} ðŸ‘‹</h2>
  <p class="text-muted mb-4">Last login: {{ user.last_login|date:"F j, Y" }}</p>

  <!-- Profile Summary -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title"><i class="fas fa-user"></i> Profile Summary</h5>
      <p><strong>Email:</strong> {{ user.email }}</p>
      <a href="{% url 'users:profile' %}" class="btn btn-outline-secondary btn-sm">Edit Profile</a>
    </div>
  </div>

  <!-- Orders: simple overview -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title"><i class="fas fa-receipt"></i> Your Orders</h5>
      {% if order_count %}
        <p class="mb-2">You have <strong>{{ order_count }}</strong> order{{ order_count|pluralize }}.</p>
      {% else %}
        <p class="mb-2">You haven't placed any orders yet.</p>
      {% endif %}
      <a href="{% url 'orders:order_history' %}" class="btn btn-outline-secondary btn-sm mt-2">View All Orders</a>
    </div>
  </div>

  <!-- Saved Items (products + bundles) -->
  <div class="card mb-4 shadow-sm" id="saved">
    <div class="card-body">
      <h5 class="card-title"><i class="fas fa-heart text-danger"></i> Saved Items</h5>

      {% with pcount=saved_products|length bcount=saved_bundles|length %}
        {% with total=pcount|add:bcount %}
          {% if total %}
            <button class="btn btn-outline-secondary btn-sm"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#savedCollapse"
                    aria-expanded="false"
                    aria-controls="savedCollapse">
              Show Saved Items ({{ total }})
            </button>

            <div class="collapse mt-3" id="savedCollapse">
              {% if pcount %}
                <h6 class="text-muted mb-2">Products ({{ pcount }})</h6>
                <ul class="list-unstyled mb-3">
                  {% for product in saved_products %}
                    <li class="d-flex align-items-center gap-3 py-2 border-bottom">
                      <a href="{% url 'products:product_detail' pk=product.id %}"
                        class="d-flex align-items-center text-decoration-none flex-grow-1">
                        {% if product.image %}
                          <img src="{{ product.image.url }}" alt="{{ product.name }}"
                              class="rounded" style="width:96px;height:96px;object-fit:cover;">
                        {% else %}
                          <div class="bg-light rounded d-flex align-items-center justify-content-center"
                              style="width:96px;height:96px;"><i class="bi bi-image text-muted"></i></div>
                        {% endif %}
                        <div class="ms-2">
                          <div class="fw-semibold">{{ product.name }}</div>
                          <div class="text-muted small">Â£{{ product.price }}</div>
                        </div>
                      </a>
                      <form method="post"
                            action="{% url 'users:save_product' product.id %}"
                            class="saved-remove-form ms-auto">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'users:dashboard' %}#saved">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                      </form>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}

              {% if bcount %}
                <h6 class="text-muted mb-2">Bundles ({{ bcount }})</h6>
                <ul class="list-unstyled mb-3">
                  {% for bundle in saved_bundles %}
                    <li class="d-flex align-items-center gap-3 py-2 border-bottom">
                      <a href="{% url 'products:bundle_detail' bundle_id=bundle.id %}"
                        class="d-flex align-items-center text-decoration-none flex-grow-1">
                        {% if bundle.image %}
                          <img src="{{ bundle.image.url }}" alt="{{ bundle.name }}"
                              class="rounded" style="width:96px;height:96px;object-fit:cover;">
                        {% else %}
                          <div class="bg-light rounded d-flex align-items-center justify-content-center"
                              style="width:96px;height:96px;"><i class="bi bi-image text-muted"></i></div>
                        {% endif %}
                        <div class="ms-2">
                          <div class="fw-semibold">{{ bundle.name }}</div>
                          <div class="text-muted small">Â£{{ bundle.price }}</div>
                        </div>
                      </a>
                      <form method="post"
                            action="{% url 'users:save_bundle' bundle.id %}"
                            class="saved-remove-form ms-auto">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'users:dashboard' %}#saved">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                      </form>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}

              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-sm btn-outline-danger" id="clear-saved-btn">
                  Clear All
                </button>
              </div>
            </div>
          {% else %}
            <p class="text-muted mb-0">You havenâ€™t saved any items yet.</p>
          {% endif %}
        {% endwith %}
      {% endwith %}
    </div>
  </div>

  <!-- Logout -->
  <form method="post" action="{% url 'account_logout' %}">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger w-35">Logout</button>
  </form>
</section>
{% endblock %}
