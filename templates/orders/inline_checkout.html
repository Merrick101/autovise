<!-- templates/orders/inline_checkout.html -->

{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container mt-5">
  <h2>Secure Checkout</h2>

  <!-- Scoped config lives on this root element -->
  <div id="inline-checkout"
       data-pk="{{ stripe_publishable_key }}"
       data-create-url="{% url 'orders:create_payment_intent' %}"
       data-update-url="{% url 'orders:update_payment_intent' %}"
       data-success-url="{{ success_url }}">

    <form id="payment-form">
      {% csrf_token %}
      {% if not request.user.is_authenticated %}
        <div class="mb-3">
          <label for="guest_email" class="form-label">Email for receipt (optional)</label>
          <input id="guest_email" name="guest_email" type="email" class="form-control" placeholder="you@example.com">
        </div>
      {% endif %}

      <!-- Shipping Address -->
      <div class="card mt-3">
        <div class="card-header">Shipping address</div>
        <div class="card-body">
          <div class="row g-3">
            
            <div class="col-md-6">
              <label for="shipping_name" class="form-label">Full name</label>
              <input id="shipping_name" name="shipping_name" required class="form-control"
                    value="{{ saved_address.name|default_if_none:'' }}">
            </div>
            
            <div class="col-md-6">
              <label for="shipping_phone" class="form-label">Phone (optional)</label>
              <input id="shipping_phone" name="shipping_phone" class="form-control"
                    value="{{ saved_address.phone|default_if_none:'' }}">
            </div>
            
            <div class="col-12">
              <label for="shipping_line1" class="form-label">Address line 1</label>
              <input id="shipping_line1" name="shipping_line1" required class="form-control"
                    value="{{ saved_address.line1|default_if_none:'' }}">
            </div>
            
            <div class="col-12">
              <label for="shipping_line2" class="form-label">Address line 2 (optional)</label>
              <input id="shipping_line2" name="shipping_line2" class="form-control"
                    value="{{ saved_address.line2|default_if_none:'' }}">
            </div>

            <div class="col-md-6">
              <label for="shipping_city" class="form-label">City / Town</label>
              <input id="shipping_city" name="shipping_city" required class="form-control"
                    value="{{ saved_address.city|default_if_none:'' }}">
            </div>
            
            <div class="col-md-3">
              <label for="shipping_postcode" class="form-label">Postcode</label>
              <input id="shipping_postcode" name="shipping_postcode" required class="form-control"
                    value="{{ saved_address.postcode|default_if_none:'' }}">
            </div>
            
            <div class="col-md-3">
              <label for="shipping_country" class="form-label">Country</label>
              <select id="shipping_country" name="shipping_country" class="form-select" required>
                <option value=""
                        {% if not saved_address or not saved_address.country %}selected{% endif %}
                        disabled>
                  Select a country
                </option>
                <option value="GB" {% if saved_address and saved_address.country == "GB" %}selected{% endif %}>
                  United Kingdom
                </option>
                <option value="IE" {% if saved_address and saved_address.country == "IE" %}selected{% endif %}>
                  Ireland
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>

      {% if request.user.is_authenticated %}
        <div class="form-check mt-3">
          <input class="form-check-input"
                type="checkbox"
                id="save_shipping"
                name="save_shipping"
                value="1"
                {% if not request.user.is_authenticated %} disabled title="Sign in to save your address" {% endif %}>
          <label class="form-check-label" for="save_shipping">
            Save this address for next time
          </label>
        </div>
      {% endif %}

      <div id="payment-element" class="mt-4"><!-- Stripe mounts here --></div>

      <button id="submit" class="btn btn-primary mt-3" type="submit" disabled>
        Pay Now
        <span id="spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
      </button>

      <div id="error-message" class="text-danger mt-2" role="alert"></div>
    </form>
  </div>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

{% endblock %}
